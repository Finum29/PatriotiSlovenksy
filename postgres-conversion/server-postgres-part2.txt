// PART 2 - Add this to server-postgres.js after the notification routes

// --- TEAM ROUTES ---

app.post('/teams/create', async (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ ok: false, message: 'Not logged in' });
  }

  const { name, description, motto } = req.body;
  if (!name) {
    return res.status(400).json({ ok: false, message: 'Team name required' });
  }

  try {
    const user = await db.findUserById(req.session.user.id);

    if (user.team_id) {
      return res.status(400).json({ ok: false, message: 'Already in a team' });
    }

    const teamId = Date.now().toString();
    const inviteCode = Math.random().toString(36).substring(2, 10).toUpperCase();

    const newTeam = await db.createTeam({
      id: teamId,
      name,
      description: description || '',
      motto: motto || '',
      captainId: user.id,
      members: [user.id],
      inviteCode,
      createdAt: new Date()
    });

    await db.updateUser(user.id, { teamId });
    req.session.user.teamId = teamId;

    res.json({ ok: true, team: newTeam });
  } catch (error) {
    console.error('Create team error:', error);
    res.status(500).json({ ok: false, message: 'Failed to create team' });
  }
});

app.get('/teams/:teamId', async (req, res) => {
  try {
    const team = await db.findTeamById(req.params.teamId);

    if (!team) {
      return res.status(404).json({ ok: false, message: 'Team not found' });
    }

    const memberDetails = await Promise.all(
      team.members.map(async (memberId) => {
        const user = await db.findUserById(memberId);
        return {
          id: user.id,
          username: user.username,
          isCaptain: user.id === team.captain_id
        };
      })
    );

    res.json({ ok: true, team: { ...team, memberDetails } });
  } catch (error) {
    console.error('Get team error:', error);
    res.status(500).json({ ok: false, message: 'Failed to get team' });
  }
});

app.post('/teams/join', async (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ ok: false, message: 'Not logged in' });
  }

  const { inviteCode } = req.body;
  
  try {
    const team = await db.findTeamByInviteCode(inviteCode);

    if (!team) {
      return res.status(404).json({ ok: false, message: 'Invalid invite code' });
    }

    const user = await db.findUserById(req.session.user.id);

    if (user.team_id) {
      return res.status(400).json({ ok: false, message: 'Already in a team' });
    }

    const members = team.members || [];
    members.push(user.id);

    await db.updateTeam(team.id, { members });
    await db.updateUser(user.id, { teamId: team.id });

    req.session.user.teamId = team.id;

    res.json({ ok: true, team });
  } catch (error) {
    console.error('Join team error:', error);
    res.status(500).json({ ok: false, message: 'Failed to join team' });
  }
});

app.post('/teams/:teamId/kick', async (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ ok: false, message: 'Not logged in' });
  }

  const { memberId } = req.body;
  
  try {
    const team = await db.findTeamById(req.params.teamId);

    if (!team) {
      return res.status(404).json({ ok: false, message: 'Team not found' });
    }

    if (team.captain_id !== req.session.user.id) {
      return res.status(403).json({ ok: false, message: 'Only captain can kick members' });
    }

    const events = await db.getAllEvents();
    const teamInEvent = events.some(e => 
      e.registrations && e.registrations.some(r => r.teamId === team.id)
    );

    if (teamInEvent) {
      return res.status(400).json({ ok: false, message: 'Cannot kick members while registered in an event' });
    }

    const members = team.members.filter(m => m !== memberId);
    await db.updateTeam(team.id, { members });
    await db.updateUser(memberId, { teamId: null });

    res.json({ ok: true });
  } catch (error) {
    console.error('Kick member error:', error);
    res.status(500).json({ ok: false, message: 'Failed to kick member' });
  }
});

app.post('/teams/leave', async (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ ok: false, message: 'Not logged in' });
  }

  try {
    const user = await db.findUserById(req.session.user.id);

    if (!user.team_id) {
      return res.status(400).json({ ok: false, message: 'Not in a team' });
    }

    const team = await db.findTeamById(user.team_id);

    if (team.captain_id === user.id) {
      return res.status(400).json({ ok: false, message: 'Captain cannot leave. Transfer captaincy or disband team' });
    }

    const events = await db.getAllEvents();
    const teamInEvent = events.some(e => 
      e.registrations && e.registrations.some(r => r.teamId === team.id)
    );

    if (teamInEvent) {
      return res.status(400).json({ ok: false, message: 'Cannot leave while team is registered in an event' });
    }

    const members = team.members.filter(m => m !== user.id);
    await db.updateTeam(team.id, { members });
    await db.updateUser(user.id, { teamId: null });

    req.session.user.teamId = null;

    res.json({ ok: true });
  } catch (error) {
    console.error('Leave team error:', error);
    res.status(500).json({ ok: false, message: 'Failed to leave team' });
  }
});

app.post('/teams/:teamId/transfer', async (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ ok: false, message: 'Not logged in' });
  }

  const { newCaptainId } = req.body;
  
  try {
    const team = await db.findTeamById(req.params.teamId);

    if (!team) {
      return res.status(404).json({ ok: false, message: 'Team not found' });
    }

    if (team.captain_id !== req.session.user.id) {
      return res.status(403).json({ ok: false, message: 'Only captain can transfer captaincy' });
    }

    if (!team.members.includes(newCaptainId)) {
      return res.status(400).json({ ok: false, message: 'New captain must be a team member' });
    }

    await db.updateTeam(team.id, { captainId: newCaptainId });

    res.json({ ok: true });
  } catch (error) {
    console.error('Transfer captaincy error:', error);
    res.status(500).json({ ok: false, message: 'Failed to transfer captaincy' });
  }
});

app.post('/teams/:teamId/disband', async (req, res) => {
  if (!req.session.user) {
    return res.status(401).json({ ok: false, message: 'Not logged in' });
  }

  try {
    const team = await db.findTeamById(req.params.teamId);

    if (!team) {
      return res.status(404).json({ ok: false, message: 'Team not found' });
    }

    if (team.captain_id !== req.session.user.id) {
      return res.status(403).json({ ok: false, message: 'Only captain can disband team' });
    }

    const events = await db.getAllEvents();
    const teamInEvent = events.some(e => 
      e.registrations && e.registrations.some(r => r.teamId === team.id)
    );

    if (teamInEvent) {
      return res.status(400).json({ ok: false, message: 'Cannot disband team while registered in an event' });
    }

    for (const memberId of team.members) {
      await db.updateUser(memberId, { teamId: null });
    }

    await db.deleteTeam(team.id);

    req.session.user.teamId = null;

    res.json({ ok: true });
  } catch (error) {
    console.error('Disband team error:', error);
    res.status(500).json({ ok: false, message: 'Failed to disband team' });
  }
});

// --- EVENT ROUTES ---

app.get('/events', async (req, res) => {
  try {
    const events = await db.getAllEvents();
    res.json({ ok: true, events });
  } catch (error) {
    console.error('Get events error:', error);
    res.status(500).json({ ok: false, message: 'Failed to get events' });
  }
});

app.post('/events/create', isAdmin, async (req, res) => {
  const { name, description, date, time, mode, eliminationType, iconUrl, streamUrl, lobbyUrl, teamSize, entryFee, firstPrize, secondPrize, thirdPrize } = req.body;

  if (!name || !date || !time || !mode) {
    return res.status(400).json({ ok: false, message: 'Missing required fields' });
  }

  try {
    const validatedTeamSize = teamSize && mode !== 'solo' ? Math.min(Math.max(parseInt(teamSize), 1), 5) : null;

    const newEvent = await db.createEvent({
      id: Date.now().toString(),
      name,
      description: description || '',
      date,
      time,
      mode,
      eliminationType: eliminationType || 'single',
      iconUrl: iconUrl || '../images/Background.png',
      streamUrl: streamUrl || '',
      lobbyUrl: lobbyUrl || '',
      teamSize: validatedTeamSize,
      entryFee: parseInt(entryFee) || 0,
      prizePool: {
        first: parseInt(firstPrize) || 0,
        second: parseInt(secondPrize) || 0,
        third: parseInt(thirdPrize) || 0
      },
      prizes: {},
      status: 'upcoming',
      registrations: [],
      matches: [],
      bracket: null,
      loserBracket: null,
      winner: null,
      createdAt: new Date()
    });

    res.json({ ok: true, event: newEvent });
  } catch (error) {
    console.error('Create event error:', error);
    res.status(500).json({ ok: false, message: 'Failed to create event' });
  }
});

// Due to length, I'll create the rest of the routes in a comprehensive guide document